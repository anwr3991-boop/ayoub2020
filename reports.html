<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>تقارير ايوب</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{ --gold:#c9a24d; }
*{ box-sizing:border-box; font-family:"Segoe UI",Tahoma,Arial; }
body{ margin:0; background:#111; color:#fff; padding:18px; }

/* ===== Header Layout (مقسوم صفين) ===== */
.header{
  max-width:980px; margin:0 auto 12px;
  display:flex; flex-direction:column; gap:10px;
}
.headerRow1{
  display:flex; align-items:flex-start; justify-content:space-between;
  gap:10px; flex-wrap:nowrap;
}
.headerRow2{
  display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
}

/* يسار: زرين عمودي */
.leftStack{
  display:flex; flex-direction:column; gap:8px; align-items:flex-start;
  flex:0 0 auto;
}
.leftStack .btn-ghost{
  padding:8px 12px;
  font-size:13px;
  border-radius:12px;
  min-width:200px;
  text-align:center;
}

/* صف الطباعة */
.printRow{ display:flex; gap:10px; flex-wrap:wrap; }

/* يمين: الشعار */
.rightSide{
  display:flex; align-items:flex-start; justify-content:flex-start;
  flex:0 0 auto;
}

/* Buttons */
.btn{ padding:10px 12px; border:none; border-radius:12px; font-weight:800; cursor:pointer; }
.btn-ghost{ background:#202020; border:1px solid rgba(201,162,77,.6); color:#e6c878; }
.btn-mini{ padding:7px 10px; font-size:12px; border-radius:10px; min-width:unset; }

/* user pill */
.pill{
  display:inline-block; padding:6px 10px; border-radius:999px;
  font-size:12px; border:1px solid rgba(201,162,77,.5); color:#e6c878;
}

/* Cards */
.card{
  max-width:980px; margin:0 auto 14px;
  background:#151515; border:1px solid rgba(201,162,77,.55);
  border-radius:16px; padding:16px;
}
h2{ margin:0 0 10px; color:#e6c878; font-size:18px; }

/* Stats */
.statRow{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
@media (max-width:860px){ .statRow{ grid-template-columns:1fr; } }
.stat{ background:#1c1c1c; border:1px solid rgba(201,162,77,.35); border-radius:14px; padding:12px; }
.big{ font-size:22px; font-weight:900; margin-top:6px; color:#fff; }
.small{ font-size:12px; color:#aaa; }
.bad{ display:none; color:#ff9a9a; font-size:13px; max-width:980px; margin:0 auto 10px; }

/* Table */
table{ width:100%; border-collapse:collapse; font-size:13px; }
th,td{
  padding:10px 8px;
  border-bottom:1px solid rgba(255,255,255,.08);
  text-align:center;
  vertical-align:middle;
}
th{ color:#e6c878; font-weight:900; }
tfoot td{ font-weight:900; color:#fff; }
.muted{ color:#aaa; }

/* ✅ توسيط عنوان الجدول والنص اللي تحته */
#tableCard h2, #tblHint{ text-align:center; }

/* ============== Logo (شعار اللواء + تأثير) ============== */
.brandWrap{
  display:flex; align-items:center; gap:10px;
  padding:8px 10px;
  border-radius:16px;
  background: radial-gradient(120px 60px at 30% 20%, rgba(201,162,77,.18), transparent 70%),
              linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));
  border:1px solid rgba(201,162,77,.35);
  position:relative;
  overflow:hidden;
}
.brandWrap:before{
  content:"";
  position:absolute; inset:-60px;
  background: conic-gradient(from 180deg, rgba(201,162,77,0), rgba(201,162,77,.28), rgba(201,162,77,0));
  filter: blur(12px);
  animation: halo 4.2s linear infinite;
  opacity:.9;
}
@keyframes halo{ to{ transform: rotate(360deg); } }

.brandLogo{
  width:52px; height:52px; border-radius:16px;
  display:grid; place-items:center;
  background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.12), rgba(255,255,255,0) 55%),
              linear-gradient(135deg, rgba(201,162,77,.35), rgba(201,162,77,.05));
  border:1px solid rgba(201,162,77,.6);
  position:relative;
  transform-style: preserve-3d;
  animation: spin3d 3.6s ease-in-out infinite;
  box-shadow:
    0 0 0 1px rgba(201,162,77,.25) inset,
    0 10px 30px rgba(0,0,0,.45),
    0 0 22px rgba(201,162,77,.25);
  overflow:hidden;
}
@keyframes spin3d{
  0%   { transform: rotateX(10deg) rotateY(0deg); }
  50%  { transform: rotateX(10deg) rotateY(180deg); }
  100% { transform: rotateX(10deg) rotateY(360deg); }
}
.brandLogo:after{
  content:"";
  position:absolute; inset:-2px;
  border-radius:18px;
  background: linear-gradient(120deg, rgba(255,255,255,0), rgba(255,255,255,.18), rgba(255,255,255,0));
  transform: translateX(-140%);
  animation: shimmer 2.4s ease-in-out infinite;
  pointer-events:none;
}
@keyframes shimmer{
  0%{ transform: translateX(-140%); opacity:.2; }
  45%{ opacity:.6; }
  100%{ transform: translateX(140%); opacity:.2; }
}

.brandLogo img{
  width:44px; height:44px;
  object-fit:contain;
  filter: drop-shadow(0 6px 10px rgba(0,0,0,.55));
  transform: translateZ(18px);
}

.brandText{
  position:relative; z-index:1;
  display:flex; flex-direction:column; line-height:1.15;
}
.brandText b{ color:#e6c878; font-size:13px; letter-spacing:.3px; }
.brandText span{ color:#cfcfcf; font-size:11px; opacity:.9; }

/* ✅ موبايل */
@media (max-width:560px){
  .headerRow1{ flex-wrap:nowrap; }
  .leftStack .btn-ghost{ min-width:200px; padding:7px 10px; font-size:12px; }
  .brandText b{ font-size:12px; }
  .brandText span{ font-size:10px; }

  .printRow{ width:100%; }
  .printRow .btn-ghost{ flex:1; }
}

/* ✅ بوكس الصلاحية في الأسفل وسط */
.footerWho{
  max-width:980px;
  margin:10px auto 0;
  display:flex;
  justify-content:center;
}

/* ✅ ستايل داخلي لتقرير السرية (مخفي عادة) */
#unitPrintCard .block{
  margin-top:12px;
  padding:12px;
  border-radius:14px;
  background:#1c1c1c;
  border:1px solid rgba(201,162,77,.35);
}
#unitPrintCard h3{
  margin:0 0 10px;
  color:#e6c878;
  font-size:15px;
  text-align:center;
}
#unitPrintCard .mini{
  font-size:12px;
  color:#aaa;
  font-weight:700;
}

/* ============== Print Control ============== */
@media print{
  body{ background:#fff !important; color:#000 !important; padding:0 !important; }
  .header{ display:none !important; }
  .footerWho{ display:none !important; }
  .card{ border:1px solid #bbb !important; background:#fff !important; color:#000 !important; box-shadow:none !important; }
  th{ color:#000 !important; }
  .muted, .small{ color:#444 !important; }
  .bad{ display:none !important; }
  body[data-print="table"] #summaryCard{ display:none !important; }
  body[data-print="summary"] #tableCard{ display:none !important; }

  /* ✅ حل الهاتف/الكمبيوتر: اطبع تقرير السرية فقط */
  body.print-unit *{ visibility:hidden !important; }
  body.print-unit #unitPrintCard,
  body.print-unit #unitPrintCard *{ visibility:visible !important; }
  body.print-unit #unitPrintCard{
    position:absolute !important;
    inset:0 !important;
    margin:0 !important;
    width:100% !important;
    display:block !important;
  }
}
</style>
</head>
<body>

<div class="header">
  <div class="headerRow1">
    <div class="rightSide">
      <div class="brandWrap" title="اللواء 604 مشاة">
        <div class="brandLogo" aria-hidden="true">
          <img src="604.png" alt="شعار اللواء 604">
        </div>
        <div class="brandText">
          <b>اللواء 604 مشاة</b>
          <span>تقارير عمليات اللواء</span>
        </div>
      </div>
    </div>

    <div class="leftStack">
      <button class="btn btn-ghost" onclick="logout()">خروج</button>
      <button class="btn btn-ghost" onclick="location.href='dashboard.html'">رجوع</button>
    </div>
  </div>

  <div class="headerRow2">
    <div class="printRow">
      <button class="btn btn-ghost" onclick="printPart('table')">طباعة جدول السرايا</button>
      <button class="btn btn-ghost" onclick="printPart('summary')">طباعة الإجمالي</button>
    </div>
    <div></div>
  </div>
</div>

<div class="bad" id="err"></div>

<div class="card" id="tableCard">
  <h2>جدول الإنجاز حسب التبعية/السرية</h2>
  <div class="small muted" id="tblHint"></div>

  <div style="overflow:auto; margin-top:10px;">
    <table>
      <thead>
        <tr>
          <th>التبعية السرية</th>
          <th>إجمالي (المستمرين)</th>
          <th>تم التسجيل</th>
          <th>لم يتم التسجيل</th>
          <th>احتياط</th>
          <th>منقطع</th>
          <th>نسبة الإنجاز</th>
          <th>تقرير</th>
        </tr>
      </thead>
      <tbody id="rowsBody"></tbody>
      <tfoot>
        <tr>
          <td>الإجمالي</td>
          <td id="t_total">—</td>
          <td id="t_done">—</td>
          <td id="t_notDone">—</td>
          <td id="t_reserve">—</td>
          <td id="t_cut">—</td>
          <td id="t_pct">—</td>
          <td class="muted">—</td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<div class="card" id="summaryCard">
  <h2 style="text-align:center;">الملخص_الاجمالي الكلي</h2>
  <div class="statRow">
    <div class="stat"><div class="small">إجمالي (المستمرين)</div><div class="big" id="total">—</div></div>
    <div class="stat"><div class="small">تم التسجيل</div><div class="big" id="done">—</div></div>
    <div class="stat"><div class="small">لم يتم التسجيل</div><div class="big" id="notDone">—</div></div>
    <div class="stat"><div class="small">نسبة الإنجاز</div><div class="big" id="pct">—</div></div>
  </div>
  <div class="small muted" id="extras" style="text-align:center; margin-top:10px;"></div>
</div>

<!-- ✅ كرت مخفي لتقرير السرية -->
<div class="card" id="unitPrintCard" style="display:none;"></div>

<div class="footerWho">
  <div class="pill" id="who"></div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyGooQCEMhVfrNWSIUVIaK050rcX3_Lj8NiqagqGHjwSChohg2lu2555uv2JmDumSM3qQ/exec";

(function clearOldLocal(){
  try{ localStorage.removeItem("token"); localStorage.removeItem("user"); }catch(e){}
})();

function getUser(){ try{return JSON.parse(sessionStorage.getItem("user")||"null")}catch{return null} }
function getToken(){ return sessionStorage.getItem("token") || ""; }
function logout(){
  sessionStorage.removeItem("token");
  sessionStorage.removeItem("user");
  location.href="index.html";
}
function showErr(m){ err.textContent=m; err.style.display="block"; }
function clearErr(){ err.textContent=""; err.style.display="none"; }

function jsonp(action, payload){
  return new Promise((resolve, reject)=>{
    const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random()*10000);
    window[cb] = (data)=>{ resolve(data); cleanup(); };

    const qs = new URLSearchParams();
    qs.set("action", action);
    qs.set("callback", cb);
    qs.set("payload", JSON.stringify(payload || {}));
    qs.set("_ts", String(Date.now()));

    const s = document.createElement("script");
    s.src = API_URL + "?" + qs.toString();
    s.onerror = ()=>{ reject(new Error("JSONP_ERROR")); cleanup(); };

    function cleanup(){
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
      if(s && s.parentNode) s.parentNode.removeChild(s);
    }
    document.body.appendChild(s);
  });
}
async function api(action, payload){ return await jsonp(action, payload); }

function requireAuth(){
  const u = getUser();
  const t = getToken();
  if(!u || !t){ location.href="index.html"; return false; }
  who.textContent = `المستخدم: ${u.full_name || u.username} — ${u.role}`;
  return true;
}
function pct_(done,total){
  if(!total) return "0%";
  const p = (done/total)*100;
  return (Math.round(p*10)/10).toString() + "%";
}

function norm(v){
  v = String(v == null ? "" : v).trim();
  v = v.replace(/\s+/g," ").trim();
  return v;
}

function escHtml(s){
  return String(s??"")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}

function getState_(r){
  // ✅ عمود platoon صار "الحالة": مستمر/احتياط/منقطع
  return norm(r.platoon || "");
}

function printPart(which){
  document.body.setAttribute("data-print", which);
  setTimeout(()=>{
    window.print();
    setTimeout(()=> document.body.removeAttribute("data-print"), 250);
  }, 50);
}

/* =========================
   ✅ تقرير سرية منفصل للطباعة (بدون Pop-up)
   ========================= */
let ALL_ROWS = [];

/* ✅ هنا حذفنا name/nid لأنك ما تبيهم يظهروا في تقرير السرية */
function makePersonRow(r){
  const serial = r.serial_unit || r.serial || "";
  const st   = getState_(r) || "غير محدد";
  const reg  = Number(r.registered || 0) === 1 ? "تم التسجيل" : "لم يتم التسجيل";
  return { serial, st, reg };
}

function tableBlock(title, arr){
  if(!arr.length) return "";
  return `
    <div class="block">
      <h3>${escHtml(title)} <span class="mini">(${arr.length})</span></h3>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>تسلسل اللواء</th>
              <th>الحالة</th>
              <th>التسجيل</th>
            </tr>
          </thead>
          <tbody>
            ${arr.map(x=>`
              <tr>
                <td>${escHtml(x.serial)}</td>
                <td>${escHtml(x.st)}</td>
                <td>${escHtml(x.reg)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function printUnitReport(depName){
  const dep = norm(depName);

  const rows = ALL_ROWS
    .filter(r => norm(r.dependency || "") === dep)
    .map(makePersonRow);

  const cont = rows.filter(x => x.st === "مستمر");
  const reserve = rows.filter(x => x.st === "احتياط");
  const cut = rows.filter(x => x.st === "منقطع");
  const other = rows.filter(x => x.st !== "مستمر" && x.st !== "احتياط" && x.st !== "منقطع");

  const done = cont.filter(x => x.reg === "تم التسجيل");
  const notDone = cont.filter(x => x.reg === "لم يتم التسجيل");

  const totalCont = cont.length;
  const doneN = done.length;
  const notDoneN = notDone.length;
  const pct = pct_(doneN, totalCont);

  const unitCard = document.getElementById("unitPrintCard");

  unitCard.innerHTML = `
    <h2 style="text-align:center; margin-bottom:6px;">تقرير السرية: ${escHtml(dep)}</h2>
    <div class="small muted" style="text-align:center; margin-bottom:10px;">
      المجموع والنسبة تُحتسب على (المستمرين) فقط — وتُعرض (احتياط/منقطع) كأرقام منفصلة
    </div>

    <div class="statRow" style="grid-template-columns:repeat(6,1fr);">
      <div class="stat"><div class="small">إجمالي المستمرين</div><div class="big">${totalCont}</div></div>
      <div class="stat"><div class="small">تم التسجيل (مستمر)</div><div class="big">${doneN}</div></div>
      <div class="stat"><div class="small">لم يتم التسجيل (المتبقي)</div><div class="big">${notDoneN}</div></div>
      <div class="stat"><div class="small">نسبة الإنجاز</div><div class="big">${escHtml(pct)}</div></div>
      <div class="stat"><div class="small">احتياط</div><div class="big">${reserve.length}</div></div>
      <div class="stat"><div class="small">منقطع</div><div class="big">${cut.length}</div></div>
    </div>

    ${other.length ? `<div class="small muted" style="text-align:center; margin-top:8px;">غير محدد: ${other.length}</div>` : ""}

    ${tableBlock("المستمرين — تم التسجيل", done)}
    ${tableBlock("المستمرين — لم يتم التسجيل (المتبقي)", notDone)}
    ${tableBlock("الاحتياط", reserve)}
    ${tableBlock("المنقطع", cut)}
    ${tableBlock("غير محدد", other)}
  `;

  unitCard.style.display = "block";

  /* ✅ الهاتف والكمبيوتر: اطبع تقرير السرية فقط */
  document.body.classList.add("print-unit");

  setTimeout(()=>{
    window.print();
    setTimeout(()=>{
      document.body.classList.remove("print-unit");
      unitCard.innerHTML = "";
      unitCard.style.display = "none";
    }, 350);
  }, 120);
}

/* زر تقرير داخل الجدول */
rowsBody.addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-dep]");
  if(!btn) return;
  const dep = btn.getAttribute("data-dep") || "";
  if(dep) printUnitReport(dep);
});

async function loadReport(){
  clearErr();
  rowsBody.innerHTML = `<tr><td colspan="8" class="muted">جارٍ التحميل...</td></tr>`;
  tblHint.textContent = "";

  try{
    const out = await api("list_all", { token:getToken() });
    if(!out.ok){
      showErr(out.error || "فشل");
      rowsBody.innerHTML = `<tr><td colspan="8" class="muted">فشل تحميل البيانات</td></tr>`;
      return;
    }

    const all = out.rows || [];
    ALL_ROWS = all;

    const map = new Map();

    let reserveAll = 0;
    let cutAll = 0;
    let otherAll = 0;

    all.forEach(r=>{
      const dep = String(r.dependency || "").trim() || "بدون";
      const reg = Number(r.registered || 0) === 1 ? 1 : 0;
      const st = getState_(r);

      if(!map.has(dep)) map.set(dep, { dep:dep, total:0, done:0, notDone:0, reserve:0, cut:0, other:0 });
      const o = map.get(dep);

      if(st === "مستمر"){
        o.total++;
        if(reg===1) o.done++; else o.notDone++;
      }else if(st === "احتياط"){
        o.reserve++; reserveAll++;
      }else if(st === "منقطع"){
        o.cut++; cutAll++;
      }else{
        o.other++; otherAll++;
      }
    });

    const list = Array.from(map.values()).sort((a,b)=>{
      const na = Number(a.dep), nb = Number(b.dep);
      if(!isNaN(na) && !isNaN(nb)) return na-nb;
      return a.dep.localeCompare(b.dep, "ar");
    });

    if(!list.length){
      rowsBody.innerHTML = `<tr><td colspan="8" class="muted">لا توجد بيانات</td></tr>`;
    }else{
      rowsBody.innerHTML = list.map(x=>`
        <tr>
          <td>${escHtml(x.dep)}</td>
          <td>${x.total}</td>
          <td>${x.done}</td>
          <td>${x.notDone}</td>
          <td>${x.reserve}</td>
          <td>${x.cut}</td>
          <td>${pct_(x.done, x.total)}</td>
          <td>
            <button class="btn btn-ghost btn-mini" data-dep="${escHtml(x.dep)}">طباعة تقرير</button>
          </td>
        </tr>
      `).join("");
    }

    const totalAll = list.reduce((s,x)=> s + x.total, 0);
    const doneAll = list.reduce((s,x)=> s + x.done, 0);
    const notDoneAll = list.reduce((s,x)=> s + x.notDone, 0);
    const pctAll = pct_(doneAll, totalAll);

    total.textContent = totalAll;
    done.textContent = doneAll;
    notDone.textContent = notDoneAll;
    pct.textContent = pctAll;

    t_total.textContent = totalAll;
    t_done.textContent = doneAll;
    t_notDone.textContent = notDoneAll;
    t_reserve.textContent = reserveAll;
    t_cut.textContent = cutAll;
    t_pct.textContent = pctAll;

    const extraParts = [
      `احتياط: ${reserveAll}`,
      `منقطع: ${cutAll}`
    ];
    if(otherAll) extraParts.push(`غير محدد: ${otherAll}`);

    extras.textContent = `لا تُحتسب هذه الفئات ضمن المجموع/النسبة — ${extraParts.join(" — ")}`;
    tblHint.textContent = `عدد السرايا الظاهرة: ${list.length} — عدد المستمرين: ${totalAll} — ${extraParts.join(" — ")}`;

  }catch(e){
    showErr("خطأ اتصال");
    rowsBody.innerHTML = `<tr><td colspan="8" class="muted">خطأ اتصال</td></tr>`;
  }
}

(function init(){
  if(!requireAuth()) return;
  loadReport();
})();
</script>

</body>
</html>
