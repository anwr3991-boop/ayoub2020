<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>تسجيل الدخول | اللواء 604 مشاة</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{ --gold:#c9a24d; --dark:#0e0e0e; }
*{ box-sizing:border-box; font-family:"Segoe UI", Tahoma, Arial; }
body{
  margin:0; min-height:100vh;
  background:linear-gradient(rgba(0,0,0,.7), rgba(0,0,0,.7)),
    url("https://images.unsplash.com/photo-1508614999368-9260051292e5");
  background-size:cover; background-position:center;
  display:flex; align-items:center; justify-content:center;
  animation: fadeIn 1s ease forwards;
}
@keyframes fadeIn{ from{opacity:0;} to{opacity:1;} }
.login-card{
  width:380px; background:rgba(15,15,15,.94);
  border:1px solid var(--gold); border-radius:18px;
  padding:28px 24px; box-shadow:0 25px 60px rgba(0,0,0,.8);
  text-align:center; animation: cardUp 1.1s ease forwards;
}
@keyframes cardUp{ from{opacity:0; transform:translateY(50px) scale(.95);} to{opacity:1; transform:translateY(0) scale(1);} }
.logo{
  width:120px; height:120px; margin:0 auto 14px;
  animation: logoEnter 1.3s ease forwards, logoFloat 4s ease-in-out infinite;
  animation-delay:0s,1.5s;
}
.logo img{ width:100%; height:100%; object-fit:contain; }
@keyframes logoEnter{ from{opacity:0; transform:translateY(-35px) scale(.8);} to{opacity:1; transform:translateY(0) scale(1);} }
@keyframes logoFloat{ 0%{transform:translateY(0);} 50%{transform:translateY(-6px);} 100%{transform:translateY(0);} }

.animate{ opacity:0; animation: slideFade .8s ease forwards; }
.a1{animation-delay:.6s;} .a2{animation-delay:.8s;} .a3{animation-delay:1s;}
.a4{animation-delay:1.2s;} .a5{animation-delay:1.4s;} .a6{animation-delay:1.6s;}
@keyframes slideFade{ from{opacity:0; transform:translateY(14px);} to{opacity:1; transform:translateY(0);} }

h1{ color:var(--gold); font-size:20px; margin:6px 0; }
h2{ color:#ddd; font-size:13px; font-weight:400; margin-bottom:18px; }
label{ display:block; text-align:right; color:#ddd; font-size:13px; margin-bottom:6px; }
input{
  width:100%; padding:11px 12px; margin-bottom:14px;
  border-radius:10px; border:1px solid #333;
  background:#111; color:#fff; outline:none;
}
input:focus{ border-color:var(--gold); box-shadow:0 0 0 2px rgba(201,162,77,.25); }
button{
  width:100%; padding:12px;
  background:linear-gradient(135deg, var(--gold), #e6c878);
  border:none; border-radius:12px; color:#111;
  font-size:15px; font-weight:700; cursor:pointer;
}
button:hover{opacity:.9;}
.error{ display:none; margin-top:12px; font-size:13px; color:#ff9a9a; }
.loading{ display:none; margin-top:10px; font-size:12px; color:#bbb; }
.footer{ margin-top:18px; font-size:11px; color:#aaa; }
</style>
</head>

<body>
<div class="login-card">
  <div class="logo"><img src="604.png" alt="شعار اللواء 604"></div>

  <h1 class="animate a1">منظومة متابعة إدخال البصمات</h1>
  <h2 class="animate a2">اللواء 604 مشاة – إدارة العمليات</h2>

  <form id="loginForm">
    <div class="animate a3">
      <label>اسم المستخدم</label>
      <input type="text" id="username" required>
    </div>

    <div class="animate a4">
      <label>كلمة المرور</label>
      <input type="password" id="password" required>
    </div>

    <button class="animate a5" type="submit">تسجيل الدخول</button>
    <div class="loading" id="loading">جارٍ التحقق...</div>

    <div class="error" id="errorMsg">بيانات الدخول غير صحيحة</div>
  </form>

  <div class="footer animate a6">© 2026 – منظومة داخلية خاصة – ايوب الحوات</div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbw4QeX2ulTazYWVadhYG3lsK17xB7y6kXhmZz7ip7tP93TOps3ylcgGbOz1zrOf2ztJaw/exec";

/* ✅ أهم إصلاح للهاتف: ما نعتمدوش على id كمتغيرات تلقائي */
const loginFormEl  = document.getElementById("loginForm");
const usernameEl   = document.getElementById("username");
const passwordEl   = document.getElementById("password");
const loadingEl    = document.getElementById("loading");
const errorMsgEl   = document.getElementById("errorMsg");

/* ✅ هنا التعديل الرئيسي: sessionStorage بدل localStorage
   - sessionStorage يمسح تلقائي أول ما تسكر المتصفح */
function setSession(token, user){
  sessionStorage.setItem("token", token);
  sessionStorage.setItem("user", JSON.stringify(user));
}
function clearSession(){
  sessionStorage.removeItem("token");
  sessionStorage.removeItem("user");
}

/* ✅ لو كان عندك جلسة في localStorage من قبل (نسخ قديمة)
   نمسحوها باش ما يصيرش فتح تلقائي من القديم */
(function clearOldLocal(){
  try{
    localStorage.removeItem("token");
    localStorage.removeItem("user");
  }catch(e){}
})();

(function autoRedirect(){
  const token = sessionStorage.getItem("token");
  const user = sessionStorage.getItem("user");
  if(token && user) location.href = "dashboard.html";
})();

// JSONP (يخدم في GitHub + file://) — ✅ مع Timeout + Cache bust
function jsonp(action, payload){
  return new Promise((resolve, reject)=>{
    const cb = "cb_" + Date.now() + "_" + Math.floor(Math.random()*10000);
    let done = false;

    const timer = setTimeout(()=>{
      if(done) return;
      done = true;
      cleanup();
      reject(new Error("JSONP_TIMEOUT"));
    }, 12000);

    window[cb] = (data)=>{
      if(done) return;
      done = true;
      clearTimeout(timer);
      resolve(data);
      cleanup();
    };

    const qs = new URLSearchParams();
    qs.set("action", action);
    qs.set("callback", cb);
    qs.set("payload", JSON.stringify(payload || {}));
    qs.set("_ts", String(Date.now())); // ✅ يمنع الكاش خصوصاً في الهاتف

    const s = document.createElement("script");
    s.src = API_URL + "?" + qs.toString();
    s.onerror = ()=>{
      if(done) return;
      done = true;
      clearTimeout(timer);
      cleanup();
      reject(new Error("JSONP_ERROR"));
    };

    function cleanup(){
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
      if(s && s.parentNode) s.parentNode.removeChild(s);
    }

    document.body.appendChild(s);
  });
}

// ✅ حل CORS: نستعمل JSONP دائمًا
async function api(action, payload){
  return await jsonp(action, payload);
}

loginFormEl.addEventListener("submit", async (e)=>{
  e.preventDefault();
  errorMsgEl.style.display="none";
  loadingEl.style.display="block";

  try{
    const out = await api("login", {
      username: usernameEl.value.trim(),
      password: passwordEl.value.trim()
    });

    loadingEl.style.display="none";

    if(out && out.ok && out.token && out.user){
      setSession(out.token, out.user);
      location.href = "dashboard.html";
    }else{
      clearSession();
      errorMsgEl.textContent = "بيانات الدخول غير صحيحة";
      errorMsgEl.style.display="block";
    }
  }catch(err){
    loadingEl.style.display="none";
    clearSession();

    if(String(err && err.message) === "JSONP_TIMEOUT"){
      errorMsgEl.textContent =
        "تعذر الاتصال بالخادم. لو يشتغل في اللابتوب وما يشتغلش في الهاتف: غالباً حظر DNS/Adblock/VPN أو كاش قديم. جرّب افتح الرابط مع ?v=1";
    }else{
      errorMsgEl.textContent =
        "خطأ اتصال. تأكد من رابط الـ Web App وأنه منشور (Deploy) بصلاحية (Anyone).";
    }
    errorMsgEl.style.display="block";
  }
});
</script>
</body>
</html>
